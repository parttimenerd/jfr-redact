# yaml-language-server: $schema=../../../config-schema.json
# hs_err preset - optimized for redacting Java crash reports (hs_err_pid*.log)
# Version: 1.0.0
#
# This preset is specifically designed for JDK developers who need to share
# hs_err files in bug reports while protecting sensitive information.
#
# hs_err files contain:
# - Hostname and OS information
# - User home directories and paths
# - Environment variables (potentially containing secrets)
# - Command line arguments (may contain passwords/tokens)
# - Process and system information
#
# Usage:
#   jfr-redact redact-text hs_err_pid12345.log --preset hserr
#
parent: default

# Discovery configuration - use fast mode for text files
discovery:
  mode: fast  # On-the-fly discovery is good for text files
  custom_extractions:
    # Extract usernames from "built on ... by" lines
    - name: "build_user"
      pattern: 'built on .* by "([^"]+)"'
      capture_group: 1
      type: USERNAME
      min_occurrences: 1
      whitelist:
        - jenkins
      enabled: true

# Property redaction - extended for hs_err content
properties:
  enabled: true
  patterns:
    - $PARENT              # Inherit all patterns from default
    - user(name)?          # Add: user, username
    - login                # Add: login
    - host(name)?          # Add: host, hostname
    - machine              # Add: machine
    - owner                # Add: owner

# String patterns - aggressive settings for hs_err
strings:
  enabled: true
  redact_in_method_names: false
  redact_in_class_names: false
  redact_in_thread_names: true  # Thread names may contain user info

  patterns:
    # User patterns - extract usernames from home directories and redact everywhere
    user:
      enabled: true
      discovery:
        enabled: true
        capture_group: 1
        min_occurrences: 1
        whitelist:
          - root
          - admin
          - test
          - user
          - guest
          - system
          - build
          - jenkins

    # Email addresses (common in configuration)
    emails:
      enabled: true

    # UUIDs (enabled for hs_err - may identify machines)
    uuids:
      enabled: true
      discovery:
        enabled: true
        capture_group: 0
        min_occurrences: 1

    # IP addresses - customize IPv4 to avoid matching version numbers like clang-1403.0.22.14.1
    ip_addresses:
      enabled: true
      # IPv4 - require first octet to be 1-255 (not 0) to avoid matching version numbers
      # IPv6 - only match full IPv6 addresses, not compressed forms like ead:: or ::1
      # which conflict with C++ method names in stack traces
      patterns:
        - '\b(?:[1-9][0-9]{0,2}\.(?:[0-9]{1,3}\.){2}[0-9]{1,3})\b'
        - '\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b'
      # Ignore compiler version numbers that look like IPs
      ignore_after:
        - 'clang-[0-9]*'      # clang version numbers like clang-1403.0.22.14.1
        - 'gcc-[0-9]*'        # gcc version numbers
        - 'g++-[0-9]*'        # g++ version numbers
        - 'LLVM [0-9]*'       # LLVM version strings

    # SSH hosts - customized for hs_err to avoid matching method references like init@0
    ssh_hosts:
      enabled: true
      discovery:
        enabled: true
        capture_group: 1
        min_occurrences: 1
        whitelist:
          - localhost
      patterns:
        - 'ssh://([a-zA-Z0-9.-]+)'
        - '(?:ssh|sftp)://(?:[^@]+@)?([a-zA-Z0-9.-]+)'
        - '[a-zA-Z0-9_-]+@([a-zA-Z][a-zA-Z0-9.-]*)(?::[0-9]+)?'
        - '(?<=ssh\s)[a-zA-Z0-9_-]+@([a-zA-Z][a-zA-Z0-9.-]+)'

    # Hostnames - ENABLED for hs_err with discovery to catch all occurrences
    hostnames:
      enabled: true
      discovery:
        enabled: true
        capture_group: 0
        min_occurrences: 1
      patterns:
        - '(?<=Host:\s)[a-zA-Z0-9][a-zA-Z0-9._-]*'
        - '(?<=Darwin\s)[a-zA-Z][a-zA-Z0-9._-]+(?=\s+\d)'
        - '(?<=Linux\s)[a-zA-Z][a-zA-Z0-9._-]+(?=\s+\d)'
      ignore_exact:
        - localhost
        - localhost.localdomain
        - 127.0.0.1
        - x86_64

    # Internal URLs - DISABLED to avoid false positives on public URLs like bugreport.java.com
    # Add specific internal URL patterns via custom patterns if needed
    internal_urls:
      enabled: false

    # Custom patterns specific to hs_err files
    custom:
      # hs_err "Host:" line - redact only the hostname at the beginning
      - name: hs_err_host_line
        patterns:
          - '(?<=Host:\s)[A-Za-z][A-Za-z0-9_-]*(?=,|\s)'
        discovery:
          enabled: false  # Already handled by hostnames pattern

      # JDK version strings - redact username in adhoc builds
      - name: jdk_adhoc_username
        patterns:
          - '(?<=adhoc\.)[a-zA-Z][a-zA-Z0-9_-]*(?=\.)'
        discovery:
          enabled: true
          capture_group: 0
          min_occurrences: 1

      # JVM command-line arguments with sensitive values
      - name: jvm_sensitive_args
        patterns:
          - '-D(?:password|secret|token|auth|credential)[^=]*=[^\s]+'
        discovery:
          enabled: false

      # Oracle/database connection strings
      - name: db_connection
        patterns:
          - 'jdbc:[a-zA-Z0-9]+://[^\s"'']+'
        discovery:
          enabled: false

      # AWS/cloud credentials in arguments
      - name: aws_credentials
        patterns:
          - '(?:AWS_|AMAZON_)[A-Z_]*(?:KEY|SECRET|TOKEN)[^\s=]*=[^\s]+'
        discovery:
          enabled: false

      # JAVA_HOME and similar paths
      - name: java_paths
        patterns:
          - '(?:JAVA_HOME|JRE_HOME|JDK_HOME)=[^\s]+'
        discovery:
          enabled: false

      # OS uptime
      - name: os_uptime
        patterns:
          - '(?<=OS uptime:\s)[^\n]+'
        discovery:
          enabled: false

      # User/group IDs
      - name: user_ids
        patterns:
          - '(?<=uid\s*:\s)\d+|(?<=euid\s*:\s)\d+|(?<=gid\s*:\s)\d+|(?<=egid\s*:\s)\d+'
        discovery:
          enabled: false

      # uname hostname
      - name: uname_hostname
        patterns:
          - '(?<=uname:\s(?:Darwin|Linux)\s)[A-Za-z][A-Za-z0-9_-]*(?=\s)'
        discovery:
          enabled: true
          capture_group: 0
          min_occurrences: 1
          whitelist:
            - localhost
            - x86_64

      # Builder username in vm_info line
      - name: vm_info_builder
        patterns:
          - '(?<=by\s")[a-zA-Z][a-zA-Z0-9_-]*(?=")'
        discovery:
          enabled: true
          capture_group: 0
          min_occurrences: 1
          whitelist:
            - jenkins

# Path redaction - aggressive for hs_err
paths:
  enabled: true
  mode: keep_filename  # Keep filename but redact directory structure

# General settings
general:
  redaction_text: "***"
  partial_redaction: false
  pseudonymization:
    enabled: false  # Enable with --pseudonymize if needed